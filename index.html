<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VerifAsset - Secure Asset Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Funky tech font: IBM Plex Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #1a1a1a;
      --bg-card: #2c2c2c;
      --bg-header: #222222;
      --bg-input: #333333;
      --border: #444444;
      --text: #e0e0e0;
      --text-muted: #888888;
      
      --neon: #00ffff; /* Neon Cyan/Aqua */
      --neon-glow: rgba(0, 255, 255, 0.2);
      --green: #00ff7f; /* Neon Green */
      --pink: #ff00ff;  /* Neon Pink/Magenta */
      
      --font-main: 'IBM Plex Mono', monospace;
    }
    
    * { box-sizing: border-box; }

    body {
      font-family: var(--font-main);
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-weight: 500;
    }
    
    .wrap { max-width: 1600px; margin: 24px auto; padding: 18px; }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      padding: 16px 24px;
      background: var(--bg-header);
      border-bottom: 2px solid var(--neon);
      box-shadow: 0 4px 20px var(--neon-glow);
    }
    header h1 { margin: 0; font-size: 24px; color: var(--neon); text-shadow: 0 0 5px var(--neon); }
    
    .stat-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 20px;
      border: 1px solid var(--border);
    }
    .stat-card h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
      text-transform: uppercase;
    }
    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--neon);
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
    }
    
    .card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0, 0.2);
    }
    
    h2 {
      font-size: 18px;
      color: var(--neon);
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    label {
      display: block;
      font-size: 14px;
      margin-top: 16px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      border-radius: 8px;
      margin-top: 8px;
      font-size: 15px;
      font-family: var(--font-main);
      color: var(--text);
    }
    
    button {
      background: var(--neon);
      color: #000;
      padding: 12px 15px;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      font-size: 16px;
      font-weight: 600;
      font-family: var(--font-main);
      transition: all 0.2s ease;
      box-shadow: 0 0 10px var(--neon-glow);
    }
    button:hover { background: #fff; box-shadow: 0 0 15px var(--neon); }
    
    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
      margin-top: 0;
      width: auto;
      background: var(--bg-input);
      color: var(--neon);
      border: 1px solid var(--neon);
      box-shadow: none;
    }
    .btn-small:hover { background: var(--neon); color: #000; }
    
    .asset-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .asset-table th, .asset-table td {
      text-align: left;
      padding: 14px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
      vertical-align: middle;
    }
    .asset-table th { color: var(--text-muted); font-weight: 600; }
    
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .status-available { background: rgba(0, 255, 127, 0.1); color: var(--green); border: 1px solid var(--green); }
    .status-in-use { background: rgba(255, 0, 255, 0.1); color: var(--pink); border: 1px solid var(--pink); }
    
    #verify-result {
      margin-top: 16px;
      padding: 16px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      display: none;
    }
    .verify-valid { background: rgba(0, 255, 127, 0.1); color: var(--green); border: 1px solid var(--green); }
    .verify-invalid { background: rgba(255, 0, 255, 0.1); color: var(--pink); border: 1px solid var(--pink); }
    
    .icon-svg { vertical-align: middle; }
    
    .small-error { color: var(--pink); font-size: 14px; margin-top: 10px; }
    .small-ok { color: var(--green); font-size: 14px; margin-top: 10px; }

    /* --- New History Modal Styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: var(--bg-card);
      margin: 10% auto;
      padding: 24px;
      border: 1px solid var(--neon);
      width: 60%;
      max-width: 700px;
      border-radius: 8px;
      box-shadow: 0 0 30px var(--neon-glow);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { border: none; }
    .modal-close {
      color: var(--text-muted);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover { color: var(--text); }
    
    .history-list { list-style: none; padding-left: 0; margin-top: 20px; }
    .history-list li {
      position: relative;
      padding: 10px 10px 10px 30px;
      border-bottom: 1px dashed var(--border);
    }
    .history-list li::before {
      content: '■';
      position: absolute;
      left: 0;
      top: 12px;
      color: var(--neon);
      font-size: 14px;
    }
    .history-list li:first-child::before { content: '►'; }
    .history-user { color: var(--text); font-weight: 600; }
    .history-action { color: var(--text-muted); font-size: 13px; text-transform: uppercase; }
    .history-time { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    @media (max-width:1100px) {
      .main-grid { grid-template-columns: 1fr; }
      .stat-bar { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="wrap">
    <header>
      <h1>VERIFY ASSET</h1>
      <div style="margin-left:auto; color: var(--text-muted); font-size: 14px;">
        STATUS: <span id="server-status" style="color: var(--pink); font-weight: 600;">OFFLINE</span>
      </div>
    </header>

    <!-- Top Stat Bar -->
    <div class="stat-bar">
      <div class="stat-card">
        <h3>Total Assets</h3>
        <div id="stat-total-assets" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Users</h3>
        <div id="stat-total-users" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <h3>Blockchain Blocks</h3>
        <div id="stat-total-blocks" class="stat-value">0</div>
      </div>
    </div>

    <div class="main-grid">
      <!-- Left Column: Asset Dashboard -->
      <div class="card">
        <h2>
          <svg class="icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
          Asset Dashboard (Live State - SQL DB)
        </h2>
        <table class="asset-table">
          <thead><tr><th>Asset ID</th><th>Name</th><th>Status</th><th>Current Holder</th><th>History</th></tr></thead>
          <tbody id="asset-table-body">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>

      <!-- Right Column: Actions -->
      <div>
        <!-- Quick Verify Card (Bloom Filter) -->
        <div class="card">
          <h2>
            <svg class="icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            Quick Verify Asset (Bloom Filter)
          </h2>
          <label for="verify-id">Scan or Enter Asset ID</label>
          <input id="verify-id" type="text" placeholder="e.g., DELL-12345" />
          <button onclick="verifyAsset()">Verify Authenticity</button>
          <div id="verify-result"></div>
        </div>

        <!-- Register New User Card -->
        <div class="card" style="margin-top: 20px;">
          <h2>
            <svg class="icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
            Register New User
          </h2>
          <label for="add-user-name">User Name</label>
          <input id="add-user-name" type="text" placeholder="e.g., Prof. Mahesh" />
          <label for="add-user-dept">Department</label>
          <input id="add-user-dept" type="text" placeholder="e.g., Physics Department" />
          <button onclick="addUser()">Register User</button>
          <div id="add-user-result" class="small-error"></div>
        </div>
        
        <!-- Register New Asset Card -->
        <div class="card" style="margin-top: 20px;">
          <h2>Register New Asset</h2>
          <label for="add-asset-id">Asset ID (e.g., QR Code)</label>
          <input id="add-asset-id" type="text" placeholder="DELL-12345" />
          <label for="add-asset-name">Asset Name</label>
          <input id="add-asset-name" type="text" placeholder="Dell XPS 15 Laptop" />
          <label for="add-asset-user">Initial Holder</label>
          <select id="add-asset-user"></select>
          <button onclick="addAsset()">Register Asset</button>
          <div id="add-result" class="small-error"></div>
        </div>

        <!-- Transfer Asset Card -->
        <div class="card" style="margin-top: 20px;">
          <h2>Transfer Asset</h2>
          <label for="transfer-asset-select">Select Asset to Transfer</label>
          <select id="transfer-asset-select"></select>
          <label for="transfer-user-select">Transfer To</label>
          <select id="transfer-user-select"></select>
          <button onclick="transferAsset()">Transfer Asset</button>
          <div id="transfer-result" class="small-error"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Row: Blockchain Audit Log -->
    <div class="card" style="margin-top: 24px;">
      <h2>
        <svg class="icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        Blockchain Audit Log (Immutable History)
      </h2>
      <div id="blocksContainer" style="max-height: 40vh; overflow:auto; padding-top:6px; border: 1px solid var(--border); border-radius: 8px;"></div>
    </div>
  </div>

  <!-- New Asset History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="history-modal-title">Asset History</h2>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <ul id="history-modal-list" class="history-list">
        <!-- History items will be loaded here -->
      </ul>
    </div>
  </div>

<script>
  const API = "http://127.0.0.1:8080";
  let allUsers = [];
  let allAssets = [];

  // --- Main function to load all data from the server ---
  async function loadDashboardData() {
    const statusEl = document.getElementById('server-status');
    try {
      const res = await fetch(API + "/get_dashboard_data");
      const data = await res.json();
      
      statusEl.textContent = "ONLINE";
      statusEl.style.color = "var(--green)";
      
      allUsers = data.users;
      allAssets = data.assets;

      populateAssetTable(data.assets);
      populateDropdowns(data.users, data.assets);
      populateStats(data.assets, data.users);
      
      // Also refresh the blockchain log
      refreshBlockchainLog();

    } catch (e) {
      statusEl.textContent = "OFFLINE";
      statusEl.style.color = "var(--pink)";
      document.getElementById('asset-table-body').innerHTML = `<tr><td colspan="5" style="color:var(--pink); text-align:center;">Failed to load dashboard data. Is the server running?</td></tr>`;
      console.error("Error loading dashboard:", e);
    }
  }

  function populateStats(assets, users) {
    document.getElementById('stat-total-assets').textContent = assets.length;
    document.getElementById('stat-total-users').textContent = users.length;
  }
  
  function populateAssetTable(assets) {
    const tableBody = document.getElementById('asset-table-body');
    tableBody.innerHTML = "";
    if (assets.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="color:var(--text-muted); text-align:center;">No assets registered yet.</td></tr>`;
      return;
    }
    assets.forEach(asset => {
      let statusClass, statusText;
      switch (asset.Status) {
        case 'Available': statusClass = 'status-available'; statusText = 'Available'; break;
        case 'In Use': statusClass = 'status-in-use'; statusText = 'In Use'; break;
        case 'Repair': statusClass = 'status-repair'; statusText = 'In Repair'; break;
        default: statusClass = ''; statusText = asset.Status;
      }
      tableBody.innerHTML += `
        <tr>
          <td><b>${asset.AssetID}</b></td>
          <td>${asset.Name}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${asset.HolderName || 'N/A'}</td>
          <td><button class="btn-small" onclick="showHistory('${asset.AssetID}', '${asset.Name}')">History</button></td>
        </tr>
      `;
    });
  }

  function populateDropdowns(users, assets) {
    const addUserSelect = document.getElementById('add-asset-user');
    const transferAssetSelect = document.getElementById('transfer-asset-select');
    const transferUserSelect = document.getElementById('transfer-user-select');

    addUserSelect.innerHTML = "";
    transferAssetSelect.innerHTML = "";
    transferUserSelect.innerHTML = "";

    users.forEach(user => {
      addUserSelect.innerHTML += `<option value="${user.UserID}">${user.Name} (${user.Department})</option>`;
      transferUserSelect.innerHTML += `<option value="${user.UserID}">${user.Name} (${user.Department})</option>`;
    });

    assets.forEach(asset => {
      transferAssetSelect.innerHTML += `<option value="${asset.AssetID}">${asset.Name} (ID: ${asset.AssetID})</option>`;
    });
  }

  // --- Action: Add a new user ---
  async function addUser() {
    const name = document.getElementById('add-user-name').value;
    const dept = document.getElementById('add-user-dept').value;
    const resultEl = document.getElementById('add-user-result');
    resultEl.className = 'small-error'; // Default to error color
    
    if (!name || !dept) {
      resultEl.textContent = "All fields are required.";
      return;
    }

    const url = `${API}/add_user?name=${encodeURIComponent(name)}&department=${encodeURIComponent(dept)}`;
    
    try {
      const res = await fetch(url);
      const j = await res.json();
      if (j.ok) {
        resultEl.textContent = `User '${name}' registered successfully!`;
        resultEl.className = 'small-ok';
        document.getElementById('add-user-name').value = '';
        document.getElementById('add-user-dept').value = '';
        loadDashboardData(); // Reload all data
      } else {
        resultEl.textContent = `Error: ${j.error}`;
      }
    } catch (e) {
      resultEl.textContent = "Server unreachable.";
    }
  }
  
  // --- Action: Add a new asset ---
  async function addAsset() {
    const assetID = document.getElementById('add-asset-id').value;
    const name = document.getElementById('add-asset-name').value;
    const holderID = document.getElementById('add-asset-user').value;
    const resultEl = document.getElementById('add-result');
    resultEl.className = 'small-error';

    if (!assetID || !name || !holderID) {
      resultEl.textContent = "All fields are required.";
      return;
    }

    const url = `${API}/add_asset?assetID=${encodeURIComponent(assetID)}&name=${encodeURIComponent(name)}&holderID=${encodeURIComponent(holderID)}`;
    
    try {
      const res = await fetch(url);
      const j = await res.json();
      if (j.ok) {
        resultEl.textContent = `Asset ${assetID} registered.`;
        resultEl.className = 'small-ok';
        document.getElementById('add-asset-id').value = '';
        document.getElementById('add-asset-name').value = '';
        loadDashboardData(); // Reload all data
      } else {
        resultEl.textContent = `Error: ${j.error}`;
      }
    } catch (e) {
      resultEl.textContent = "Server unreachable.";
    }
  }

  // --- Action: Transfer an asset ---
  async function transferAsset() {
    const assetID = document.getElementById('transfer-asset-select').value;
    const newHolderID = document.getElementById('transfer-user-select').value;
    const resultEl = document.getElementById('transfer-result');
    resultEl.className = 'small-error';

    if (!assetID || !newHolderID) {
      resultEl.textContent = "Both fields are required.";
      return;
    }

    const url = `${API}/transfer_asset?assetID=${encodeURIComponent(assetID)}&newHolderID=${encodeURIComponent(newHolderID)}`;
    
    try {
      const res = await fetch(url);
      const j = await res.json();
      if (j.ok) {
        resultEl.textContent = `Asset ${assetID} transferred.`;
        resultEl.className = 'small-ok';
        loadDashboardData(); // Reload all data
      } else {
        resultEl.textContent = `Error: ${j.error}`;
      }
    } catch (e) {
      resultEl.textContent = "Server unreachable.";
    }
  }

  // --- Action: Verify an asset (Bloom Filter) ---
  async function verifyAsset() {
    const assetID = document.getElementById('verify-id').value;
    const resultEl = document.getElementById('verify-result');
    
    if (!assetID) {
      resultEl.innerHTML = "Please enter an Asset ID.";
      resultEl.className = "verify-invalid";
      resultEl.style.display = 'block';
      return;
    }

    const url = `${API}/verify_asset?assetID=${encodeURIComponent(assetID)}`;
    
    try {
      const res = await fetch(url);
      const j = await res.json();
      
      if (j.found) {
        resultEl.innerHTML = `
          <svg class="icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12.75L11.25 15L15 9.75M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          VALID ASSET ID
        `;
        resultEl.className = "verify-valid";
      } else {
        resultEl.innerHTML = `
          <svg class="icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 8V12M12 16H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          INVALID / UNREGISTERED ID
        `;
        resultEl.className = "verify-invalid";
      }
      resultEl.style.display = 'block';

    } catch (e) {
      resultEl.innerHTML = "Verification service failed.";
      resultEl.className = "verify-invalid";
      resultEl.style.display = 'block';
    }
  }

  // --- Action: Refresh the blockchain display ---
  async function refreshBlockchainLog() {
    try {
        const res = await fetch(API + "/get_blockchain_log");
        const j = await res.json();
        const container = document.getElementById('blocksContainer');
        container.innerHTML = "";
        if (!j.blocks) { container.innerHTML = "<pre>" + JSON.stringify(j, null, 2) + "</pre>"; return; }

        document.getElementById('stat-total-blocks').textContent = j.blocks.length;

        for (let b of j.blocks) {
            let el = document.createElement('div');
            el.className = 'block';
            let html = `<div><b>Block ${b.index}</b> — merkle: <small>${b.merkle_root}</small></div>`;
            html += `<details style="margin-top:8px"><summary>${b.txs.length} log entries</summary><pre style="margin-top:8px">`;
            for (let tx of b.txs) {
                html += `[${new Date(tx.timestamp / 1e6).toLocaleString()}]\n`; // Convert nanoseconds to milliseconds
                html += `ACTION:   ${tx.action}\n`;
                // === THIS IS THE BUG FIX (v1.3.2) ===
                // The typo was here. It's now 'html +=' not 'html.innerHTML +='
                html += `ASSET:    ${tx.assetID}\n`; 
                // === END OF BUG FIX ===
                html += `HOLDER:   User ID ${tx.newHolderID}\n`;
                html += `TXID:     ${tx.txid}\n\n`;
            }
            html += `</pre></details>`;
            el.innerHTML = html;
            container.appendChild(el);
        }
    } catch (e) {
        document.getElementById('blocksContainer').innerHTML = `<div class="small-error">Blockchain log unreachable.</div>`;
        console.error("Error refreshing blockchain log:", e);
    }
  }
  
  // --- New History Modal Functions ---
  const modal = document.getElementById('historyModal');
  
  async function showHistory(assetID, assetName) {
    const listEl = document.getElementById('history-modal-list');
    document.getElementById('history-modal-title').textContent = `History for: ${assetName} (${assetID})`;
    listEl.innerHTML = "<li>Loading history...</li>";
    modal.style.display = "block";
    
    try {
      const res = await fetch(`${API}/get_asset_history?assetID=${encodeURIComponent(assetID)}`);
      const history = await res.json();
      
      listEl.innerHTML = ""; // Clear loading
      if (history.length === 0) {
        listEl.innerHTML = "<li>No history found for this asset.</li>";
        return;
      }
      
      history.forEach(entry => {
        const time = new Date(parseInt(entry.Timestamp) / 1e6).toLocaleString();
        listEl.innerHTML += `
          <li>
            <div class="history-action">${entry.Action}</div>
            <div class="history-user">${entry.HolderName || 'N/A'}</div>
            <div class="history-time">${time}</div>
          </li>
        `;
      });
      
    } catch(e) {
      listEl.innerHTML = `<li><span class="small-error">Failed to load history.</span></li>`;
    }
  }
  
  function closeModal() {
    modal.style.display = "none";
  }
  
  // Close modal if user clicks outside of it
  window.onclick = function(event) {
    if (event.target == modal) {
      closeModal();
    }
  }

  // Load all data when the page starts
  window.onload = loadDashboardData;
</script>
</body>
</html>

